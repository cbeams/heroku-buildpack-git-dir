#!/bin/sh

set -x

ENV_DIR=${3:-}
HEROKU_GIT_USERNAME="$(cat $ENV_DIR/HEROKU_GIT_USERNAME)"
HEROKU_GIT_PASSWORD="$(cat $ENV_DIR/HEROKU_GIT_PASSWORD)"

cat > $1/.netrc <<EOM
machine git.heroku.com
  password $HEROKU_GIT_PASSWORD
  login $HEROKU_GIT_USERNAME
EOM

git clone https://git.heroku.com/$HEROKU_APP_NAME.git temp_git_clone_dir

git -C temp_git_clone_dir checkout $HEROKU_SLUG_COMMIT

mkdir $1/.git
cp -r temp_git_clone_dir/.git/* $1/.git

# Debug
git -C $1 status

rm -rf temp_git_clone_dir
